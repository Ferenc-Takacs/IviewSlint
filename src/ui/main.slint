
import { VerticalBox, HorizontalBox } from "std-widgets.slint";

component MenuItem inherits Rectangle {
    in property <string> text;
    in property <bool> is_top_level: false;
    callback click();
    callback moved(PointerEvent);
    width: layout.preferred-width + 20px; 
    height: is_top_level ? 30px : 25px;
    background: ta.has_hover ? #4a4a4a : transparent; // Hover effekt
    border_radius: 3px;
    ta := TouchArea {
        mouse_cursor: pointer;
        clicked => { root.click(); }
        pointer_event(event) => { root.moved(event); }
    }    
    layout := HorizontalLayout {
        padding_left: 5px;
        padding_right: 5px;
        Text {
            text: root.text;
            color: white;
            horizontal_alignment: center;
            vertical_alignment: center;
            font_size: 12px;
        }
    }
}

export component MainWindow inherits Window {
    width: 800px;
    height: 600px;
    title: "IviewSlint - Image viewer";
    background: #1a1a1a;


    VerticalBox {
        padding: 0px;
        spacing: 0px;
        
        Rectangle {
            height: 30px;
            background: #252525;

            HorizontalBox {
                padding_left: 5px; padding_right: 5px;
                padding_top: 0px; padding_bottom: 0px;
                spacing: 5px;
                alignment: start;

                file_btn := MenuItem {
                    text: "File";
                    is_top_level: true;
                    click => {
                        root.title = "File Katt!";
                        root.file_menu_visible = !root.file_menu_visible;
                        root.options_menu_visible = false;
                        root.menu_active = root.file_menu_visible;
                    }
                    moved(event) => {
                        if (event.kind == PointerEventKind.move && root.menu_active) {
                            root.file_menu_visible = true;
                            root.options_menu_visible = false;
                        }
                    }
                }

                opt_btn := MenuItem {
                    text: "Options";
                    is_top_level: true;
                    click => {
                        root.title = "Option Katt!"; 
                        root.options_menu_visible = !root.options_menu_visible;
                        root.file_menu_visible = false;
                        root.menu_active = root.options_menu_visible;
                    }
                    moved(event) => {
                        if (event.kind == PointerEventKind.move && root.menu_active) {
                            root.options_menu_visible = true;
                            root.file_menu_visible = false;
                        }
                    }
                }

                // Elválasztó
                Rectangle { width: 2px; background: #444; height: 20px; }
                
                // Léptető Gombok
                MenuItem { text: "<< B"; is_top_level: true; click => {
                    root.title = "<< Katt!";  close_menu(); root.prev_image() } width: 60px; }

                MenuItem { text: ">> N"; is_top_level: true; click => {
                    root.title = ">> Katt!"; close_menu(); root.next_image() } width: 60px; }

                // Animáció vezérlő
                MenuItem { text: "▶ Play"; is_top_level: true; click => {
                    root.title = "Play Katt!"; close_menu(); root.play_animation() }  width: 80px; }
            }
        }

        Rectangle {
            clip: true; // Ha a kép nagyobb, ne lógjon ki
            background: #121212;

            Flickable {
                viewport-width: img.source.width * root.zoom_level * 1px;
                viewport-height: img.source.height * root.zoom_level * 1px;

                img := Image {
                    source: root.current_image;
                    width: parent.viewport-width;
                    height: parent.viewport-height;
                    image-fit: contain;
                }
            }
            
            if (root.menu_active) : TouchArea {clicked => { close_menu(); } }
        }

    }

    if (root.file_menu_visible) :
        Rectangle {
            x: file_btn.absolute-position.x;
            y: 30px; // A menüsor magassága
            width: 180px;
            height: file_col.preferred-height;
            background: #2d2d2d;
            border-width: 1px; border-color: #444;
            
            file_col := VerticalBox {
                padding: 4px; spacing: 2px;
                MenuItem { text: "Open ... (O)"; click => { close_menu(); root.open_file(); } }
                MenuItem { text: "Reopen (R)"; click => { close_menu(); root.reopen_file(); } }
                MenuItem { text: "Save ... (S)"; click => { close_menu(); root.save_file(); } }
                MenuItem { text: "Save View ... (Shift+S)"; click => { close_menu(); root.save_file(); } }
                MenuItem { text: "Recent Paths (P)"; click => { close_menu(); root.recent_paths(); } }
                Rectangle { height: 1px; background: #444; } // Elválasztó vonal
                MenuItem { text: "Copy (Ctrl+C)"; click => { close_menu(); root.copy_image(); } }
                MenuItem { text: "Copy View (Ctrl+Shift+C)"; click => { close_menu(); root.copy_view(); } }
                MenuItem { text: "Past (Ctrl+V)"; click => { close_menu(); root.paste_image(); } }
                MenuItem { text: "Change (Ctrl+X)"; click => { close_menu(); root.change_image(); } }
                MenuItem { text: "Change View (Ctrl+Shift+X)"; click => { close_menu(); root.change_view(); } }
                Rectangle { height: 1px; background: #444; } // Elválasztó vonal
                MenuItem { text: "About (A)"; click => { close_menu(); root.about(); } }
                MenuItem { text: "Exit"; click => { close_menu(); root.exit(); } }
            }
        }

    if (root.options_menu_visible) :
        Rectangle {
            x: opt_btn.absolute-position.x;
            y: 30px;
            width: 150px;
            height: opt_col.preferred-height;
            background: #2d2d2d;
            border-width: 1px; border_color: #444;

            opt_col := VerticalBox {
                padding: 4px;
                MenuItem { text: "Info"; click => { close_menu(); root.info_clicked(); } }
                MenuItem { text: "Color Setting (I)"; click => { close_menu(); root.color_setting(); } }
                MenuItem { text: "Change Background (D)"; click => { close_menu(); root.background(); } }
            }
        }

    function close_menu() {
        root.file_menu_visible = false;
        root.options_menu_visible = false;
        root.menu_active = false;
    }



    // A popupok pozícióját globális property-kben tároljuk, mert a popup belsejébe nem látunk be
    property <bool> file_menu_visible: false;
    property <bool> options_menu_visible: false;
    property <bool> menu_active: false;
    
    // Callback-ek, amiket Rust-ból fogunk meghívni/kezelni
    in-out property <image> pasted_image;
    in-out property <image> current_image;
    in-out property <float> zoom_level: 1.0;

    callback background();
    callback up();
    callback down();
    callback left();
    callback righ();
    callback plus();
    callback minus();
    callback red_channel();
    callback green_channel();
    callback blue_channel();
    callback invert_channels();
    callback color_setting();
    callback open_file();
    callback reopen_file();
    callback save_file();
    callback save_view();
    callback recent_paths();
    callback copy_image();
    callback copy_view();
    callback paste_image();
    callback change_image();
    callback change_view();
    callback about();
    callback prev_image();
    callback next_image();
    callback play_animation();
    callback info_clicked();
    callback exit();
    // Callback-ek a popupok kezeléséhez
    callback show_file_menu(length, length);
    callback show_options_menu(length, length);


    forward_focus: key_handler;
    key_handler := FocusScope {
        key_pressed(event) => {
            if (event.modifiers.alt) {
            }
            else {
                if (event.modifiers.control) {
                    if (event.modifiers.shift) {
                        if (event.text == "c" || event.text == "C" ) { root.copy_view(); return accept; }
                        if (event.text == "x" || event.text == "X" ) { root.change_view(); return accept; }
                    }
                    else {
                        if (event.text == "c") { root.copy_image(); return accept; }
                        if (event.text == "v") { root.paste_image(); return accept; }
                        if (event.text == "x") { root.change_image(); return accept;}
                        if (event.text == "r") { root.red_channel(); return accept;}
                        if (event.text == "g") { root.green_channel(); return accept;}
                        if (event.text == "b") { root.blue_channel(); return accept;}
                        if (event.text == "i") { root.invert_channels(); return accept;}
                        if (event.text == up) { root.up(); return accept;}
                        if (event.text == down) { root.down(); return accept;}
                        if (event.text == left) { root.left(); return accept;}
                        if (event.text == right) { root.right(); return accept;}
                    }
                }
                else {
                    if (event.modifiers.shift ) {
                        if (event.text == "s" || event.text == "S" ) { root.save_view(); return accept; }
                    }
                    else {
                        if (event.text == "c") { root.color_setting(); return accept; }
                        if (event.text == "o") { root.open_file(); return accept; }
                        if (event.text == "r") { root.reopen_file(); return accept; }
                        if (event.text == "s") { root.save_file(); return accept; }
                        if (event.text == "p") { root.recent_paths(); return accept; }
                        if (event.text == "a") { root.about(); return accept; }
                        if (event.text == "d") { root.background(); return accept; }
                        if (event.text == plus) { root.plus(); return accept; }
                        if (event.text == minus) { root.minus(); return accept; }
                    }
                }
            }
            reject
        }
    }


}

